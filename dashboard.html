<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Rekod Pergerakan - SKM</title>
    
    <style>
        /* Gaya CSS anda dikekalkan seperti sebelum ini */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 10px; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 1400px; margin: auto; background-color: #ffffff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); width: 100%; flex-grow: 1; box-sizing: border-box; overflow: hidden; }
        h2 { text-align: center; color: #222; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px; margin-bottom: 20px; font-size: 1.5em; }
        .controls-container { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px; }
        .filter-group { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .filter-group label { font-weight: 600; color: #333; margin-bottom: 3px; }
        input[type="date"], input[type="text"], select, button { padding: 10px 12px; border-radius: 6px; border: 1px solid #ced4da; font-size: 14px; width: 100%; box-sizing: border-box; }
         button { width: auto; padding: 10px 15px; cursor: pointer; background-color: #0056b3; color: white; border-color: #0056b3; font-weight: 600; transition: background-color 0.2s ease;}
         button:hover { background-color: #004494; }
        .controls-buttons { display: flex; gap: 10px; justify-content: space-between; width: 100%; }
        #reset-button { background-color: #6c757d; border-color: #6c757d; }
        #reset-button:hover { background-color: #5a6268; }
        #print-button { background-color: #28a745; border-color: #28a745; }
        #print-button:hover { background-color: #218838; }
        #rekod-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; min-width: 900px; border-collapse: separate; border-spacing: 0; margin-top: 20px; border: 1px solid #dee2e6; border-radius: 8px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; vertical-align: middle; white-space: nowrap; }
         td.col-tujuan, th.col-tujuan, td.col-destinasi, th.col-destinasi { white-space: normal; word-wrap: break-word;}
        th:first-child, td:first-child { width: auto; text-align: right; }
        th { background-color: #f1f3f5; font-weight: 600; color: #333; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 1; }
        tbody tr:last-child td { border-bottom: 0; }
        tbody tr:hover { background-color: #f8f9fa; }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-weight: 600; font-size: 11px; display: inline-block; text-align: center; min-width: 50px;}
        .status-baru { background-color: #fff0c2; color: #7a5c00; }
        .status-dilihat { background-color: #e9ecef; color: #495057; }
        .status-default { background-color: #d1ecf1; color: #0c5c60; }
        .nav-link { display: block; text-align: center; margin-top: 25px; color: #0056b3; font-weight: 600; }
        #loading { text-align: center; padding: 50px; font-size: 1.2em; color: #888; }
        #pagination-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 25px; }
        #pagination-controls button { width: auto; padding: 8px 15px; }
        #pagination-controls button:disabled { background-color: #ced4da; border-color: #ced4da; cursor: not-allowed; }
        #page-info { font-weight: 600; color: #333; font-size: 14px; }
        footer { text-align: center; padding: 20px 10px; margin-top: 30px; color: #888; font-size: 12px; }
        
        @media (min-width: 768px) {
             body { padding: 20px; }
             .container { padding: 30px; }
             .controls-container { flex-direction: row; justify-content: space-between; }
             .filter-group { flex-direction: row; width: auto; }
             .filter-group label { margin-bottom: 0; }
              input, select { width: auto; }
             .controls-buttons { width: auto; }
             h2 { font-size: 1.8em; }
             th, td { padding: 14px 18px; font-size: 14px; }
              th { font-size: 12px; }
             .status-badge { padding: 5px 12px; font-size: 12px; min-width: 60px;}
             #pagination-controls button { width: 120px; }
         }
        @media print {
            body { background-color: #fff; padding: 0; font-size: 9pt; width: 100%; }
            .container { box-shadow: none; border: 0; width: 100% !important; padding: 0; }
            .controls-container, .nav-link, #pagination-controls, footer { display: none; }
            h2 { text-align: center; font-size: 14pt; margin-bottom: 15px; }
            #rekod-container { overflow: visible; }
            table { width: 100%; border: 1px solid #999; table-layout: auto; min-width: 0; }
            th, td { padding: 5px 6px; font-size: 8pt; white-space: normal; word-wrap: break-word; border-bottom: 1px solid #ccc; }
            th { background-color: #eee; font-weight: 600; }
            .status-badge { background-color: #fff !important; color: #000 !important; border: 1px solid #ccc; padding: 2px 5px; font-size: 7pt; }
            tr { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>Dashboard Rekod Pergerakan Staf</h2>
        <div class="controls-container">
            <div class="filter-group">
                <label for="filter-tarikh">Tarikh Hantar Rekod:</label>
                <input type="date" id="filter-tarikh">
                <label for="filter-nama">Saring Nama:</label>
                <input type="text" id="filter-nama" placeholder="Taip nama staf...">
                <label for="filter-wilayah">Saring Wilayah:</label>
                <select id="filter-wilayah">
                    <option value="">Semua Wilayah</option>
                    <option value="SKM Negeri Sabah">SKM Negeri Sabah</option>
                    <option value="SKM Wilayah PBS">SKM Wilayah PBS</option>
                    <option value="SKM Wilayah PBU">SKM Wilayah PBU</option>
                    <option value="SKM W.P Labuan">SKM W.P Labuan</option>
                    <option value="SKM Wilayah Beaufort">SKM Wilayah Beaufort</option>
                    <option value="SKM Wilayah Keningau">SKM Wilayah Keningau</option>
                    <option value="SKM Wilayah Ranau">SKM Wilayah Ranau</option>
                    <option value="SKM Wilayah Kota Marudu">SKM Wilayah Kota Marudu</option>
                    <option value="SKM Wilayah Kudat">SKM Wilayah Kudat</option>
                    <option value="SKM Wilayah Sandakan">SKM Wilayah Sandakan</option>
                    <option value="SKM Wilayah Lahad Datu">SKM Wilayah Lahad Datu</option>
                    <option value="SKM Wilayah Tawau">SKM Wilayah Tawau</option>
                </select>
            </div>
             <div class="controls-buttons">
                <button id="reset-button">Papar Semua</button>
                <button id="print-button">üñ®Ô∏è Cetak Laporan</button>
             </div>
        </div>
        <div id="rekod-container">
            <p id="loading">Memuat turun rekod...</p>
        </div>
        <div id="pagination-controls">
            <button id="prev-button" disabled>Sebelum</button>
            <span id="page-info">Halaman 1</span>
            <button id="next-button" disabled>Seterusnya</button>
        </div>
        <a href="index.html" class="nav-link">Kembali ke Borang Permohonan</a>
    </div>
    
    <footer>
        <p>Hak Cipta Terpelihara &copy; Harriet Justine, Unit Pengurusan dan Teknologi Maklumat. Inovasi Untuk Semua.</p>
    </footer>

    <script>
        const API_SERVER_URL = 'https://projek-skm-server.onrender.com';
        const rekodContainer = document.getElementById('rekod-container');
        const loadingElement = document.getElementById('loading');
        const filterTarikhInput = document.getElementById('filter-tarikh');
        const filterNamaInput = document.getElementById('filter-nama');
        const filterWilayahInput = document.getElementById('filter-wilayah');
        const resetButton = document.getElementById('reset-button');
        const printButton = document.getElementById('print-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const pageInfo = document.getElementById('page-info');
        
        let semuaRekod = [];
        let rekodYangDitapis = [];
        let currentPage = 1;
        const recordsPerPage = 50;

        function parseTimestampToUTCMillis(timestampStr) { /* ... (fungsi ini dikekalkan) ... */ 
             if (!timestampStr || typeof timestampStr !== 'string') return null;
             const parts = timestampStr.split(','); if (parts.length < 1) return null;
             const datePart = parts[0].trim(); const timePart = parts[1] ? parts[1].trim() : '00:00:00';
             if (datePart.includes('/')) {
                 const dateParts = datePart.split('/');
                 if (dateParts.length === 3) {
                     const timeParts = timePart.split(':');
                     const yyyy = parseInt(dateParts[2], 10); const MM = parseInt(dateParts[1], 10) - 1; const dd = parseInt(dateParts[0], 10);
                     const hh = parseInt(timeParts[0] || '0', 10); const mm = parseInt(timeParts[1] || '0', 10); const ss = parseInt(timeParts[2] || '0', 10);
                     if (!isNaN(yyyy) && !isNaN(MM) && !isNaN(dd) && !isNaN(hh) && !isNaN(mm) && !isNaN(ss)) {
                        const utcMillis = Date.UTC(yyyy, MM, dd, hh, mm, ss);
                        const tempDate = new Date(utcMillis);
                        if (tempDate.getUTCFullYear() === yyyy && tempDate.getUTCMonth() === MM && tempDate.getUTCDate() === dd) { return utcMillis; }
                     }
                 }
             }
             try { const dateObj = new Date(timestampStr); if (!isNaN(dateObj.getTime())) { return dateObj.getTime(); }
             } catch (e) { /* Abaikan */ }
              console.warn("Gagal parse timestamp:", timestampStr); return null;
        }
        function normalizeDateFromTimestamp(timestampStr) { /* ... (fungsi ini dikekalkan) ... */ 
             const millis = parseTimestampToUTCMillis(timestampStr); if (!millis) return ''; 
              const dateObj = new Date(millis); const year = dateObj.getUTCFullYear(); const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0'); const day = String(dateObj.getUTCDate()).padStart(2, '0'); return `${year}-${month}-${day}`;
        }

        async function muatNaikRekod() { /* ... (fungsi ini dikekalkan) ... */ 
             loadingElement.style.display = 'block'; rekodContainer.innerHTML = '<p id="loading">Memuat turun rekod...</p>'; document.getElementById('pagination-controls').style.display = 'none'; 
             try { const response = await fetch(`${API_SERVER_URL}/get-rekod`, { cache: 'no-cache' }); if (!response.ok) throw new Error(`Server Error: ${response.statusText}`); let data = await response.json(); if (!Array.isArray(data)) { console.error("Data diterima bukan array:", data); data = []; }
                 data.sort((a, b) => { const timeA = parseTimestampToUTCMillis(a.timestamp); const timeB = parseTimestampToUTCMillis(b.timestamp); if (timeA === null && timeB === null) return 0; if (timeA === null) return 1; if (timeB === null) return -1; return timeB - timeA; });
                 semuaRekod = data; rekodYangDitapis = semuaRekod; currentPage = 1; paparkanRekod();
             } catch (error) { console.error('Ralat memuat turun rekod:', error); rekodContainer.innerHTML = '<p style="color: red; text-align: center;">Gagal memuat turun rekod. Sila pastikan server backend berjalan dan URL adalah betul.</p>'; document.getElementById('pagination-controls').style.display = 'none'; }
        }

        // ## PERUBAHAN UTAMA DI SINI ##
        function paparkanRekod() {
            loadingElement.style.display = 'none';
            rekodContainer.innerHTML = ''; 

            console.log("Memaparkan data untuk halaman:", currentPage, rekodYangDitapis); // DEBUG

            if (!rekodYangDitapis || rekodYangDitapis.length === 0) {
                rekodContainer.innerHTML = '<p style="text-align: center;">Tiada rekod ditemui.</p>';
                document.getElementById('pagination-controls').style.display = 'none';
                return;
            }
            
            document.getElementById('pagination-controls').style.display = 'flex';
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const dataUntukPaparan = rekodYangDitapis.slice(startIndex, endIndex);
            
            console.log("Data slice:", dataUntukPaparan); // DEBUG

            const table = document.createElement('table');
            const nowMillis = Date.now(); 

            // Bina header jadual
            let tableHTML = `
                <thead>
                    <tr>
                        <th class="col-no">No.</th>
                        <th class="col-timestamp">Tarikh Hantar</th>
                        <th class="col-nama">Nama Staf</th>
                        <th class="col-jenis">Jenis Pergerakan</th>
                        <th class="col-destinasi">Destinasi</th>
                        <th class="col-tarikh">Tarikh Mula</th>
                        <th class="col-tarikh">Tarikh Akhir</th>
                        <th class="col-tempat">Tempat Bertugas</th>
                        <th class="col-tujuan">Tujuan</th>
                        <th class="col-status">Status</th>
                    </tr>
                </thead>
                <tbody>`;

            // Bina baris jadual menggunakan loop biasa (lebih mudah debug)
            for (let i = 0; i < dataUntukPaparan.length; i++) {
                const rekod = dataUntukPaparan[i];
                const index = i; // Index dalam halaman semasa

                // Pastikan rekod adalah objek yang sah
                if (typeof rekod !== 'object' || rekod === null) {
                    console.error("Data rekod tidak sah:", rekod);
                    continue; // Langkau rekod ini
                }
                
                const recordMillis = parseTimestampToUTCMillis(rekod.timestamp);
                const hoursDiff = recordMillis !== null ? (nowMillis - recordMillis) / (1000 * 60 * 60) : Infinity; 
                let statusPaparan = rekod.status || 'N/A';
                let statusClass = 'status-default';
                if (rekod.status === 'BARU') {
                    if (hoursDiff > 24) { 
                        statusPaparan = 'Dilihat';
                        statusClass = 'status-dilihat';
                    } else {
                        statusClass = 'status-baru'; 
                    }
                } else {
                     if (statusPaparan === 'Dilihat') statusClass = 'status-dilihat';
                }

                // Guna fungsi escapeHTML untuk keselamatan (elak XSS)
                const escapeHTML = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;') : '';

                // Bina string HTML untuk satu baris
                 let rowHTML = `
                    <tr>
                        <td class="col-no">${startIndex + index + 1}</td>
                        <td class="col-timestamp">${escapeHTML((rekod.timestamp || '').split(',')[0])}</td> 
                        <td class="col-nama">${escapeHTML(rekod.nama_staf)}</td>
                        <td class="col-jenis">${escapeHTML(rekod.jenis_pergerakan)}</td>
                        <td class="col-destinasi">${escapeHTML(rekod.destinasi)}</td>
                        <td class="col-tarikh">${escapeHTML(rekod.tarikh_mula)}</td>
                        <td class="col-tarikh">${escapeHTML(rekod.tarikh_akhir)}</td>
                        <td class="col-tempat">${escapeHTML(rekod.tempat_bertugas)}</td>
                        <td class="col-tujuan">${escapeHTML(rekod.tujuan)}</td>
                        <td class="col-status"><span class="status-badge ${statusClass}">${escapeHTML(statusPaparan)}</span></td>
                    </tr>
                `;
                tableHTML += rowHTML; // Tambah baris ke HTML keseluruhan
            }

            tableHTML += `</tbody>`; // Tutup tbody
            table.innerHTML = tableHTML; // Masukkan HTML ke dalam elemen jadual
            
            rekodContainer.appendChild(table); // Tambah jadual ke dalam container

            // Kemas kini pagination seperti biasa
            const totalPages = Math.ceil(rekodYangDitapis.length / recordsPerPage);
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages}`;
            prevButton.disabled = (currentPage === 1);
            nextButton.disabled = (currentPage === totalPages || totalPages === 0);
        }

        function saringRekod() { /* ... (fungsi ini dikekalkan) ... */ 
             const tarikhDipilih = filterTarikhInput.value; const namaDimasukkan = filterNamaInput.value.toLowerCase(); const wilayahDipilih = filterWilayahInput.value; let rekodDisaring = semuaRekod;
             if (tarikhDipilih) { rekodDisaring = rekodDisaring.filter(rekod => { const tarikhHantar = normalizeDateFromTimestamp(rekod.timestamp); return tarikhHantar && tarikhHantar === tarikhDipilih; }); }
             if (namaDimasukkan) { rekodDisaring = rekodDisaring.filter(rekod => rekod.nama_staf && rekod.nama_staf.toLowerCase().includes(namaDimasukkan) ); }
             if (wilayahDipilih) { rekodDisaring = rekodDisaring.filter(rekod => rekod.tempat_bertugas === wilayahDipilih); }
             rekodYangDitapis = rekodDisaring; currentPage = 1; paparkanRekod();
        }

        // Event Listeners dikekalkan
        document.addEventListener('DOMContentLoaded', muatNaikRekod);
        filterTarikhInput.addEventListener('change', saringRekod);
        filterNamaInput.addEventListener('input', saringRekod);
        filterWilayahInput.addEventListener('change', saringRekod);
        resetButton.addEventListener('click', () => { filterTarikhInput.value = ''; filterNamaInput.value = ''; filterWilayahInput.value = ''; rekodYangDitapis = semuaRekod; currentPage = 1; paparkanRekod(); });
        printButton.addEventListener('click', () => { window.print(); });
        prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; paparkanRekod(); } });
        nextButton.addEventListener('click', () => { const totalPages = Math.ceil(rekodYangDitapis.length / recordsPerPage); if (currentPage < totalPages) { currentPage++; paparkanRekod(); } });
    </script>
</body>
</html>