<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal V4.0 - Enterprise</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- GAYA PROFESIONAL (V4.0) --- */
        :root { 
            --primary: #1a252f; /* Darker Navy */
            --secondary: #2c3e50; 
            --accent: #3498db; 
            --light: #ecf0f1; 
            --danger: #e74c3c; 
            --success: #27ae60; 
            --warning: #f39c12;
            --bg-body: #f4f6f9;
        }
        
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg-body); display: flex; height: 100vh; overflow: hidden; font-size: 14px; }
        
        /* LOGIN */
        #login-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 8px; width: 350px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        .login-box h2 { margin-top: 0; color: var(--secondary); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .login-box button:hover { background: #2980b9; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--primary); color: #ecf0f1; display: flex; flex-direction: column; transition: 0.3s; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.1); }
        .sidebar-header h3 { margin: 0; font-size: 18px; letter-spacing: 1px; }
        .sidebar-menu { padding-top: 20px; flex: 1; }
        .sidebar-menu a { display: flex; align-items: center; padding: 12px 25px; color: #bdc3c7; text-decoration: none; transition: 0.3s; border-left: 4px solid transparent; cursor: pointer; font-weight: 500; }
        .sidebar-menu a:hover, .sidebar-menu a.active { background: var(--secondary); color: white; border-left-color: var(--accent); }
        .sidebar-menu a i { margin-right: 15px; width: 20px; text-align: center; }
        
        /* MAIN CONTENT */
        .main-content { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; }
        
        /* TOP BAR (NEW) */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .page-title h2 { margin: 0; font-size: 20px; color: var(--secondary); display: flex; align-items: center; gap: 10px; }
        .year-selector { display: flex; align-items: center; gap: 10px; }
        .year-selector select { padding: 8px 12px; border-radius: 4px; border: 1px solid #ddd; font-weight: bold; color: var(--secondary); cursor: pointer; }
        
        /* CARDS */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: space-between; transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); }
        .card h3 { margin: 0; font-size: 28px; color: var(--primary); }
        .card p { margin: 5px 0 0; color: #7f8c8d; font-size: 13px; font-weight: 600; text-transform: uppercase; }
        .card-icon { font-size: 40px; opacity: 0.15; }

        /* TABLES */
        .table-container { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow: hidden; }
        .table-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 20px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        th { background: #f8f9fa; color: #555; font-weight: 600; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; }
        tr:hover { background-color: #fcfcfc; }
        
        /* BUTTONS & FORMS */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; transition: 0.2s; color: white; text-decoration: none; display: inline-block;}
        .btn-sm { padding: 5px 10px; font-size: 11px; }
        .btn-primary { background: var(--accent); }
        .btn-primary:hover { background: #2980b9; }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #c0392b; }
        .btn-success { background: var(--success); }
        .btn-success:hover { background: #219150; }
        .form-control { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content { background-color: white; margin: 30px auto; padding: 25px; border-radius: 8px; width: 600px; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .close { float: right; font-size: 24px; font-weight: bold; cursor: pointer; color: #aaa; }
        .close:hover { color: #333; }
        .form-row { display: flex; gap: 15px; }
        .form-group { flex: 1; margin-bottom: 5px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 12px; color: #555; }

        /* UTILS */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .badge-new { background: #fff3cd; color: #856404; }
        .badge-ok { background: #d4edda; color: #155724; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary)">Sistem Admin SKM</h2>
            <p style="color:#7f8c8d; margin-bottom:20px;">Log masuk untuk akses sistem</p>
            <input type="text" id="login-user" placeholder="Nama Pengguna" onkeypress="handleEnter(event)">
            <input type="password" id="login-pass" placeholder="Kata Laluan" onkeypress="handleEnter(event)">
            <button onclick="login()">LOG MASUK</button>
            <p id="login-msg" style="color: red; margin-top: 15px; font-size: 13px;"></p>
        </div>
    </div>

    <div class="sidebar" id="sidebar" style="display: none;">
        <div class="sidebar-header">
            <h3><i class="fas fa-user-shield"></i> ADMIN PANEL</h3>
            <p id="admin-name-display" style="font-size: 12px; opacity: 0.7; margin-top:5px;">User</p>
        </div>
        <div class="sidebar-menu">
            <a onclick="showSection('dashboard')" class="active" id="link-dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a onclick="showSection('records')" id="link-records"><i class="fas fa-list-alt"></i> Urus Rekod</a>
            <a onclick="showSection('analytics')" id="link-analytics"><i class="fas fa-chart-pie"></i> Analitik Individu</a>
            <a onclick="showSection('profile')" id="link-profile"><i class="fas fa-user-circle"></i> Profil Admin</a>
            <a onclick="logout()" style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1);"><i class="fas fa-sign-out-alt"></i> Log Keluar</a>
        </div>
    </div>

    <div class="main-content" id="main-content" style="display: none;">
        
        <div class="top-bar">
            <div class="page-title">
                <h2 id="page-title-text"><i class="fas fa-tachometer-alt"></i> Papan Pemuka</h2>
            </div>
            <div class="year-selector">
                <span style="color:#555; font-weight:600;"><i class="fas fa-calendar-alt"></i> Tahun Data:</span>
                <select id="global-year-select" onchange="changeYear()">
                    </select>
                <button class="btn btn-success btn-sm" onclick="loadData()"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
        </div>

        <div id="sec-dashboard" class="section active">
            <div class="card-grid">
                <div class="card">
                    <div><h3 id="stat-total">0</h3><p>Jumlah Rekod</p></div>
                    <i class="fas fa-folder-open card-icon" style="color: var(--accent);"></i>
                </div>
                <div class="card">
                    <div><h3 id="stat-today">0</h3><p>Permohonan Hari Ini</p></div>
                    <i class="fas fa-calendar-check card-icon" style="color: var(--success);"></i>
                </div>
                <div class="card">
                    <div><h3 id="stat-staff">0</h3><p>Kakitangan Aktif</p></div>
                    <i class="fas fa-users card-icon" style="color: var(--warning);"></i>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3 style="margin:0; font-size:16px; color:var(--primary);">üèÜ Top 5 Kakitangan Paling Aktif</h3>
                </div>
                <div class="table-responsive">
                    <table id="top-staff-table"><thead><tr><th>Nama Kakitangan</th><th>Jumlah Pergerakan</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="sec-records" class="section">
            <div class="table-container">
                <div class="table-header">
                    <input type="text" id="search-records" placeholder="Cari nama, destinasi..." style="padding:8px; border:1px solid #ddd; border-radius:4px; width:250px;">
                    <button class="btn btn-primary" onclick="exportToCSV()"><i class="fas fa-file-csv"></i> Eksport CSV</button>
                </div>
                <div class="table-responsive">
                    <table id="records-table">
                        <thead><tr><th>Tarikh Hantar</th><th>Nama</th><th>Jenis</th><th>Destinasi</th><th>Masa/Tempoh</th><th>Status</th><th style="width:140px;">Tindakan</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-analytics" class="section">
            <div class="table-container" style="padding:20px;">
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <select id="analisis-nama" class="form-control" style="margin:0; max-width:300px;"><option value="">-- Pilih Kakitangan --</option></select>
                    <button class="btn btn-primary" onclick="analisisStaf()">Jana Laporan</button>
                </div>
                
                <div id="analisis-result" style="display:none; border-top:1px solid #eee; padding-top:20px;">
                    <h3 id="analisis-title" style="margin-top:0;"></h3>
                    <p>Jumlah Pergerakan Tahun Ini: <strong id="analisis-total" style="font-size:1.2em; color:var(--accent);"></strong></p>
                    <table id="analisis-table" style="margin-top:15px; border:1px solid #eee;">
                        <thead><tr><th style="background:#eee;">Tarikh</th><th>Jenis</th><th>Destinasi & Tujuan</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-profile" class="section">
            <div class="table-container" style="padding:30px; max-width:500px;">
                <h3 style="margin-top:0;">Kemaskini Profil Admin</h3>
                <label>Username (Kekal)</label><input type="text" id="prof-user" class="form-control" disabled style="background:#f9f9f9;">
                <label>Nama Penuh</label><input type="text" id="prof-nama" class="form-control">
                <label>Kata Laluan Baru</label><input type="password" id="prof-pass" class="form-control" placeholder="Biarkan kosong jika tidak tukar">
                <button class="btn btn-success" onclick="updateProfile()" style="width:100%; margin-top:10px;">Simpan Perubahan</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="tutupModal()">&times;</span>
            <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Kemaskini Rekod</h3>
            <form id="editForm">
                <input type="hidden" id="edit_timestamp">
                <div class="form-group"><label>Nama Staf</label><input type="text" id="edit_nama" class="form-control" required></div>
                <div class="form-row">
                    <div class="form-group"><label>Jenis</label>
                        <select id="edit_jenis" class="form-control">
                            <option value="UR - Urusan Rasmi/Koperasi">UR - Urusan Rasmi</option>
                            <option value="Kursus/Latihan">Kursus/Latihan</option>
                            <option value="Bekerja Dari Rumah">BDR</option>
                            <option value="CR - Cuti Rehat">CR - Cuti Rehat</option>
                            <option value="MC - Cuti Sakit">MC - Cuti Sakit</option>
                            <option value="CG - Cuti Gantian">CG - Cuti Gantian</option>
                            <option value="CK - Cuti Kuarantin">CK - Cuti Kuarantin</option>
                            <option value="CB - Cuti Bersalin">CB - Cuti Bersalin</option>
                            <option value="Kebenaran 4 Jam / HRMIS">Kebenaran 4 Jam</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Status</label>
                        <select id="edit_status" class="form-control">
                            <option value="BARU">BARU</option>
                            <option value="DILULUSKAN">DILULUSKAN</option>
                            <option value="DITOLAK">DITOLAK</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Destinasi</label><input type="text" id="edit_destinasi" class="form-control"></div>
                
                <div class="form-row">
                    <div class="form-group"><label>Masa Mula</label><input type="time" id="edit_masa_mula" class="form-control"></div>
                    <div class="form-group"><label>Masa Tamat</label><input type="time" id="edit_masa_tamat" class="form-control"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Tarikh Mula</label><input type="date" id="edit_tarikh_mula" class="form-control"></div>
                    <div class="form-group"><label>Tarikh Akhir</label><input type="date" id="edit_tarikh_akhir" class="form-control"></div>
                </div>
                <div class="form-group"><label>Tempat Bertugas</label>
                    <select id="edit_tempat" class="form-control">
                        <option value="SKM Negeri Sabah">SKM Negeri Sabah</option>
                        <option value="SKM Wilayah PBS">SKM Wilayah PBS</option>
                        <option value="SKM Wilayah PBU">SKM Wilayah PBU</option>
                        <option value="SKM W.P Labuan">SKM W.P Labuan</option>
                        <option value="SKM Wilayah Beaufort">SKM Wilayah Beaufort</option>
                        <option value="SKM Wilayah Keningau">SKM Wilayah Keningau</option>
                        <option value="SKM Wilayah Ranau">SKM Wilayah Ranau</option>
                        <option value="SKM Wilayah Kota Marudu">SKM Wilayah Kota Marudu</option>
                        <option value="SKM Wilayah Kudat">SKM Wilayah Kudat</option>
                        <option value="SKM Wilayah Sandakan">SKM Wilayah Sandakan</option>
                        <option value="SKM Wilayah Lahad Datu">SKM Wilayah Lahad Datu</option>
                        <option value="SKM Wilayah Tawau">SKM Wilayah Tawau</option>
                    </select>
                </div>
                <div class="form-group"><label>Tujuan</label><textarea id="edit_tujuan" class="form-control" rows="2"></textarea></div>
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px;">Simpan Data</button>
            </form>
        </div>
    </div>

<script>
    const API_URL = 'https://projek-skm-server.onrender.com';
    let allData = [];
    const currentYear = new Date().getFullYear();

    // 1. INIT TAHUN SELECTOR
    function initYearSelector() {
        const select = document.getElementById('global-year-select');
        select.innerHTML = '';
        for(let i=0; i<4; i++) {
            let year = currentYear - i;
            let opt = document.createElement('option');
            opt.value = year;
            opt.text = year + (year === currentYear ? " (Semasa)" : " (Arkib)");
            select.appendChild(opt);
        }
    }

    function handleEnter(e) { if(e.key === 'Enter') login(); }

    async function login() {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        const btn = document.querySelector('.login-box button');
        btn.textContent = "Memproses..."; btn.disabled = true;

        try {
            const res = await fetch(`${API_URL}/admin/login`, {
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username: u, password: p})
            });
            const data = await res.json();
            if(data.success) {
                sessionStorage.setItem('admin_user', JSON.stringify(data.user));
                initAdmin();
            } else { document.getElementById('login-msg').innerText = data.message; }
        } catch(e) { alert("Gagal menyambung ke server."); }
        btn.textContent = "LOG MASUK"; btn.disabled = false;
    }

    function initAdmin() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('sidebar').style.display = 'flex';
        document.getElementById('main-content').style.display = 'flex';
        
        initYearSelector();
        const user = JSON.parse(sessionStorage.getItem('admin_user'));
        document.getElementById('admin-name-display').innerText = user.nama + " (" + user.jawatan + ")";
        document.getElementById('prof-user').value = user.username;
        document.getElementById('prof-nama').value = user.nama;
        
        loadData();
    }

    function logout() { sessionStorage.removeItem('admin_user'); location.reload(); }

    function changeYear() {
        loadData();
    }

    async function loadData() {
        const selectedYear = document.getElementById('global-year-select').value;
        const btn = document.querySelector('.top-bar button');
        const icon = btn.querySelector('i');
        icon.classList.add('fa-spin'); // Animasi loading
        
        const tbody = document.querySelector('#records-table tbody');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Memuat turun data...</td></tr>';

        try {
            // Hantar parameter tahun ke API
            const res = await fetch(`${API_URL}/get-rekod?year=${selectedYear}`);
            allData = await res.json();
            
            if (!Array.isArray(allData)) allData = [];

            // Sort Timestamp Terkini ke Lama (V4 Logic)
            allData.sort((a, b) => (b.timestamp || '').localeCompare(a.timestamp || ''));

            renderDashboard();
            renderRecordsTable();
            populateStaffDropdown();
        } catch(e) { 
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">Gagal memuat turun data.</td></tr>';
        }
        icon.classList.remove('fa-spin');
    }

    function renderRecordsTable() {
        const tbody = document.querySelector('#records-table tbody');
        tbody.innerHTML = '';
        
        if (allData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Tiada rekod dijumpai untuk tahun ini.</td></tr>';
            return;
        }

        allData.forEach(r => {
            let masaInfo = `${r.tarikh_mula}`;
            if(r.masa_mula && r.masa_tamat) masaInfo += `<br><small style="color:#666">${r.masa_mula} - ${r.masa_tamat}</small>`;
            
            let badgeClass = r.status === 'BARU' ? 'badge-new' : 'badge-ok';
            
            tbody.innerHTML += `
                <tr>
                    <td>${(r.timestamp||'').split(',')[0]}</td>
                    <td><strong>${r.nama_staf}</strong></td>
                    <td>${r.jenis_pergerakan}</td>
                    <td>${r.destinasi}</td>
                    <td>${masaInfo}</td>
                    <td><span class="badge ${badgeClass}">${r.status}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick='bukaModal(${JSON.stringify(r).replace(/'/g, "&#39;")})'><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" onclick='padamRekod("${r.timestamp}")'><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    // Helper: Format Masa Input
    function convertTimeForInput(timeStr) {
        if (!timeStr) return '';
        if (timeStr.includes(':') && !timeStr.toUpperCase().includes('M')) return timeStr;
        const match = timeStr.match(/(\d+):(\d+)(?:\s*)(AM|PM)/i);
        if (match) {
            let hours = parseInt(match[1]);
            const minutes = match[2];
            const ampm = match[3].toUpperCase();
            if (ampm === 'PM' && hours !== 12) hours += 12;
            if (ampm === 'AM' && hours === 12) hours = 0;
            return `${String(hours).padStart(2, '0')}:${minutes}`;
        }
        return '';
    }

    function bukaModal(rekod) {
        document.getElementById('edit_timestamp').value = rekod.timestamp;
        document.getElementById('edit_nama').value = rekod.nama_staf;
        document.getElementById('edit_jenis').value = rekod.jenis_pergerakan;
        document.getElementById('edit_destinasi').value = rekod.destinasi;
        
        document.getElementById('edit_masa_mula').value = convertTimeForInput(rekod.masa_mula);
        document.getElementById('edit_masa_tamat').value = convertTimeForInput(rekod.masa_tamat);
        document.getElementById('edit_tarikh_mula').value = rekod.tarikh_mula;
        document.getElementById('edit_tarikh_akhir').value = rekod.tarikh_akhir;
        
        document.getElementById('edit_tempat').value = rekod.tempat_bertugas;
        document.getElementById('edit_tujuan').value = rekod.tujuan;
        document.getElementById('edit_status').value = rekod.status;
        document.getElementById('editModal').style.display = "block";
    }

    function tutupModal() { document.getElementById('editModal').style.display = "none"; }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.textContent = "Menyimpan..."; btn.disabled = true;

        const body = { 
            original_timestamp: document.getElementById('edit_timestamp').value,
            nama_staf: document.getElementById('edit_nama').value,
            jenis_pergerakan: document.getElementById('edit_jenis').value,
            destinasi: document.getElementById('edit_destinasi').value,
            masa_mula: document.getElementById('edit_masa_mula').value,
            masa_tamat: document.getElementById('edit_masa_tamat').value,
            tarikh_mula: document.getElementById('edit_tarikh_mula').value,
            tarikh_akhir: document.getElementById('edit_tarikh_akhir').value,
            tempat_bertugas: document.getElementById('edit_tempat').value,
            tujuan: document.getElementById('edit_tujuan').value,
            status: document.getElementById('edit_status').value
        };

        try {
            const res = await fetch(`${API_URL}/admin/update`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
            });
            const result = await res.json();
            if(result.success) { alert("Rekod berjaya dikemaskini."); tutupModal(); loadData(); } 
            else { alert("Gagal: " + result.message); }
        } catch(e) { alert("Ralat sambungan."); }
        btn.textContent = "Simpan Data"; btn.disabled = false;
    });

    // Dashboard Logic
    function renderDashboard() {
        document.getElementById('stat-total').innerText = allData.length;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('stat-today').innerText = allData.filter(r => (r.tarikh_mula||'').includes(today)).length;
        
        const staffCount = {}; 
        allData.forEach(r => { if(r.nama_staf) staffCount[r.nama_staf] = (staffCount[r.nama_staf] || 0) + 1; });
        document.getElementById('stat-staff').innerText = Object.keys(staffCount).length;

        const sortedStaff = Object.entries(staffCount).sort((a,b) => b[1] - a[1]).slice(0, 5);
        const tbody = document.querySelector('#top-staff-table tbody'); tbody.innerHTML = '';
        sortedStaff.forEach(([name, count]) => tbody.innerHTML += `<tr><td>${name}</td><td><strong>${count}</strong></td></tr>`);
    }

    // Features
    async function padamRekod(ts) { 
        if(confirm("Adakah anda pasti mahu memadam rekod ini secara kekal?")) {
            fetch(`${API_URL}/admin/delete`, {
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({timestamp: ts})
            }).then(res => res.json()).then(data => {
                if(data.success) { alert("Rekod dipadam."); loadData(); }
                else { alert("Gagal memadam."); }
            });
        }
    }
    
    function filterTable() { 
        const term = document.getElementById('search-records').value.toLowerCase(); 
        document.querySelectorAll('#records-table tbody tr').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
        }); 
    }
    
    function populateStaffDropdown() { 
        const uniqueNames = [...new Set(allData.map(item => item.nama_staf))].sort(); 
        const select = document.getElementById('analisis-nama'); 
        select.innerHTML = '<option value="">-- Pilih Kakitangan --</option>'; 
        uniqueNames.forEach(name => select.innerHTML += `<option value="${name}">${name}</option>`); 
    }
    
    function analisisStaf() { 
        const nama = document.getElementById('analisis-nama').value; 
        if(!nama) return; 
        const records = allData.filter(r => r.nama_staf === nama); 
        document.getElementById('analisis-result').style.display = 'block'; 
        document.getElementById('analisis-title').innerText = "Laporan: " + nama; 
        document.getElementById('analisis-total').innerText = records.length; 
        
        const tbody = document.querySelector('#analisis-table tbody'); tbody.innerHTML = ''; 
        records.forEach(r => tbody.innerHTML += `<tr><td>${r.tarikh_mula}</td><td>${r.jenis_pergerakan}</td><td>${r.destinasi}<br><small>${r.tujuan}</small></td></tr>`); 
    }
    
    function exportToCSV() { 
        const year = document.getElementById('global-year-select').value;
        let csv = "Timestamp,Nama,Jenis,Destinasi,TarikhMula,TarikhAkhir\n"; 
        allData.forEach(r => csv += `"${r.timestamp}","${r.nama_staf}","${r.jenis_pergerakan}","${r.destinasi}","${r.tarikh_mula}","${r.tarikh_akhir}"\n`); 
        const link = document.createElement("a"); 
        link.href = encodeURI("data:text/csv;charset=utf-8," + csv); 
        link.download = `Laporan_SKM_${year}.csv`; 
        link.click(); 
    }

    // Navigation
    function showSection(id) { 
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
        document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active')); 
        document.getElementById('sec-' + id).classList.add('active'); 
        document.getElementById('link-' + id).classList.add('active'); 
        
        // Update Title
        const titles = { 'dashboard': 'Papan Pemuka', 'records': 'Pengurusan Rekod', 'analytics': 'Analitik Staf', 'profile': 'Tetapan Profil' };
        document.getElementById('page-title-text').innerHTML = `<i class="fas fa-circle"></i> ${titles[id]}`;
    }

    async function updateProfile() {
        const user = JSON.parse(sessionStorage.getItem('admin_user'));
        const newName = document.getElementById('prof-nama').value;
        const newPass = document.getElementById('prof-pass').value;
        const body = { username: user.username, new_nama: newName };
        if(newPass) body.new_password = newPass;
        
        const res = await fetch(`${API_URL}/admin/update-profile`, {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const data = await res.json();
        if(data.success) alert("Profil dikemaskini. Sila login semula."); else alert("Gagal.");
    }

    if(sessionStorage.getItem('admin_user')) initAdmin();
</script>

</body>
</html>